base_url: "http://localhost:8080"   # mailboxd; change to https://host if needed
verify_tls: false
soap_login: "never"                 # skip SOAP pre-login for app passwords

defaults:
  headers:
    Content-Type: "application/x-www-form-urlencoded"

tests:
  - name: "Shim App Password: success"
    method: POST
    path: /service/extension/zpush-shim
    # Replace with a real account and its app-specific password
    body: "action=authenticate&username=user@example.com&password=APP_PASSWORD_HERE&protocol=eas"
    expect:
      status: 200
      json:
        success: true

  - name: "Shim App Password: failure"
    method: POST
    path: /service/extension/zpush-shim
    # Intentionally wrong password to verify failure path
    body: "action=authenticate&username=user@example.com&password=WRONG_PASSWORD&protocol=eas"
    expect:
      status: 401
      contains: "auth failed"

  # Optional: Exercise zsync/AutoDiscover paths by disabling IMAP fallback or IMAP on the account.
  # Before running, on the server set:
  #   ZPUSH_SHIM_BASIC_FALLBACK=0 (or -Dzpush.shim.basic.fallback=false)
  #   ZPUSH_SHIM_AUTODISCOVER_FALLBACK=1 (default true)
  # Or disable IMAP for the test account.
  - name: "Shim App Password: success (zsync/AutoDiscover path)"
    method: POST
    path: /service/extension/zpush-shim
    body: "action=authenticate&username=user@example.com&password=APP_PASSWORD_HERE&protocol=eas&debug=1"
    expect:
      status: 200
      json:
        success: true
