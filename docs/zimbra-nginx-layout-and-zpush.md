Zimbra 10 NGINX Templates + Z-Push (Zimbra Backend)
===================================================

Overview
--------
This guide explains Zimbra’s NGINX layout and template system, how `zconfigd` regenerates configs, and how to integrate Z-Push (ActiveSync) with the Zimbra Backend in a containerized php-fpm deployment. It keeps HTTP→HTTPS redirects, supports strict server names and SANs, and includes triage, timeouts, and size limits.

Key principles
--------------
- Edit templates, not generated includes. Regenerate via `zmproxyctl restart`.
- Route only the EAS and Autodiscover endpoints to Z-Push.
- Keep Z-Push on loopback (127.0.0.1) behind Zimbra’s TLS proxy.
- Preserve client IP headers and tune long timeouts for EAS.

Zimbra NGINX layout
-------------------
- Generated config: `/opt/zimbra/conf/nginx/includes/` and main includes are not hand-edited. They are regenerated by `zconfigd`/`zmproxyconfgen` based on template files.
- Templates (edit here): `/opt/zimbra/conf/nginx/templates/`
  - `nginx.conf.web.template` (global http block)
  - `nginx.conf.web.http.template(.default)`
  - `nginx.conf.web.https.template(.default)`
- Regeneration: `zmproxyctl restart` → `zconfigd` invokes `zmproxyconfgen` to render templates to includes. To prevent regeneration of a single file, templates can be annotated, but the best practice is to patch templates in-place.

Template DSL essentials
-----------------------
- Variables like `${web.mail.proxy_port}` are expanded.
- Conditionals: `{if ...}{/if}` enable/disable blocks.
- Explode iterates arrays (e.g., `server_name` across hostnames).

Safe change strategy
--------------------
1) Patch templates under `/opt/zimbra/conf/nginx/templates/` to add:
   - An `upstream zpush` in a shared/global `http {}` context.
   - Two `location` stanzas in HTTPS server blocks for mail/autodiscover/tmail.
2) Run `zmproxyctl restart` to regenerate and reload.
3) If you need to revert, restore from a backup and restart proxy.

Containerized Z-Push with Zimbra Backend
----------------------------------------
We ship a small nginx+php-fpm container configured to serve only:
- `/Microsoft-Server-ActiveSync`
- `/autodiscover/Autodiscover.xml`

Repo layout (this project)
--------------------------
- `nginx/` (container root)
  - `Dockerfile` (nginx + php-fpm)
  - `docker-compose.yml` (binds `127.0.0.1:${ZPUSH_HTTP_PORT}`)
  - `nginx-zpush.conf` (fastcgi to php-fpm; health endpoint)
  - `entrypoint.sh` (php/nginx tuning; persistent config/state/log)
  - `env.example` (copy to `.env`)
  - `manage.sh` (fetch/build/run, template helpers)
  - `zpush/config/config.php.sample` (BackendZimbra; persisted)

Fetch Z-Push and Zimbra Backend
-------------------------------
- Z-Push source: `https://github.com/Z-Hub/Z-Push`
- Zimbra Backend: SourceForge
  - Latest: `https://sourceforge.net/projects/zimbrabackend/files/latest/download`
  - Release 74 install: `https://sourceforge.net/projects/zimbrabackend/files/Release74/zpzb-install.sh/download`
  - Release 74 tarball: `https://sourceforge.net/projects/zimbrabackend/files/Release74/zimbra74.tgz/download`
  - INSTALL notes: `https://sourceforge.net/projects/zimbrabackend/files/Release74/INSTALL/download`

We’ve automated this in `nginx/manage.sh`:
- `./manage.sh --init`
- `./manage.sh --fetch` (clones Z-Push into `build/z-push`)
- `./manage.sh --fetch-backend` (downloads + stages the Zimbra Backend; pinned to Release74 by default in `env.example`)
- `./manage.sh --vendor-backend` (copies backend into `build/z-push/backend/zimbra`)
- `./manage.sh --up` (builds+starts container on 127.0.0.1:9073)

Zimbra NGINX snippets
---------------------
Use `./manage.sh --print-nginx` for a copy-paste. Summary:
- In a shared http{} (e.g. `nginx.conf.web.template`) add:
  upstream zpush { server 127.0.0.1:9073; keepalive 10; }
- In HTTPS server{} templates (mail/autodiscover/tmail vhosts), add:
  - `location = /Microsoft-Server-ActiveSync { proxy_pass http://zpush; ... }`
  - `location ~* ^/autodiscover/Autodiscover\.xml$ { proxy_pass http://zpush; ... }`
Keep HTTP: all HTTP 80 requests redirect to HTTPS per `zimbraReverseProxyMailMode`.

Server names, SANs, and strict names
------------------------------------
- Enable strict names: `zmprov mcf zimbraReverseProxyStrictServerName TRUE`
- Define hostnames per domain:
  - `zmprov md example.com +zimbraVirtualHostname mail.example.com`
  - `zmprov md example.com +zimbraVirtualHostname autodiscover.example.com`
  - `zmprov md example.com +zimbraVirtualHostname tmail.example.com`
- Set public service host/protocol/port as required (HTTPS on 443).
- SANs: ensure your TLS cert includes `mail`, `autodiscover` (and `tmail` if used).
- Testing tmail: add `/etc/hosts` entry pointing `tmail.example.com` to the proxy IP.

End-to-end request flow
-----------------------
1) Client hits `https://mail.example.com/Microsoft-Server-ActiveSync`.
2) Zimbra NGINX terminates TLS, matches HTTPS server_name, routes location to `proxy_pass http://zpush`.
3) Container’s nginx hands off to php-fpm which executes Z-Push `index.php` with `BackendZimbra`.
4) Backend connects to Zimbra via SOAP/HTTP(S) and returns EAS responses.
5) Response flows back; proxy preserves `Host` and forwards client IP in `X-Forwarded-For`.

Headers and timeouts
--------------------
- Preserve: `Host`, `X-Real-IP`, `X-Forwarded-For`, `X-Forwarded-Proto`.
- EAS needs long timeouts (idle, sync, upload): e.g. `proxy_read_timeout 3600s`.
- Container defaults: PHP `max_execution_time=3600`, `max_input_time=3600`.

Attachment and message size limits
----------------------------------
- PHP: `upload_max_filesize`, `post_max_size` (container env in `.env`).
- NGINX: `client_max_body_size` (both Zimbra proxy and container site).
- Zimbra EAS: `zmprov mcf zimbraMobileMaxMessageSize 102400000` (≈100MB) then `zmmailboxdctl restart`.
Align all three to the same or higher value to avoid 413/504 issues.

Regeneration and deployment
---------------------------
- Patch templates under `/opt/zimbra/conf/nginx/templates/`.
- Verify/dry-run locally with `./manage.sh --verify-templates` (pass target dir).
- Deploy your edits on the Zimbra host and run: `zmproxyctl restart`.

No-Zimbra host workflow (local template tree)
---------------------------------------------
If you have a local copy of templates (e.g., `/home/jad/openai/zimbra74/nginx/opt/zimbra/config`), you can auto-inject snippets:
- `./manage.sh --patch-templates-auto /home/jad/openai/zimbra74/nginx/opt/zimbra/config`
  - Creates simple `.bak` copies next to edited files.
  - Adds `upstream zpush` to the main web template and EAS/Autodiscover `location` blocks to HTTPS templates with clear markers.
  - Review diffs; rerun the command safely (idempotent via markers).
When ready to deploy on a real Zimbra host, repeat the edits on `/opt/zimbra/conf/nginx/templates/` and run `zmproxyctl restart`.

Triage checklist
----------------
- 502/504: check container `./manage.sh --logs`; increase timeouts; backend reachable; PHP-FPM running.
- 401/403: wrong credentials, account policy, or backend auth to Zimbra.
- 404: template not patched or wrong server_name matched; strict names misconfigured.
- 413: increase `client_max_body_size` and PHP sizes; align Zimbra EAS limit.
- Curl tests:
  - `curl -Ik https://mail.example.com/Microsoft-Server-ActiveSync`
  - `curl -sD- https://autodiscover.example.com/autodiscover/Autodiscover.xml -o /dev/null`

Jetty CGI vs php-fpm container
-------------------------------
Pros (php-fpm):
- Isolates Z-Push from mailboxd/Jetty; easier PHP tuning; smaller blast radius.
- Leans on nginx+php-fpm best practices and resource controls.
Cons:
- Another moving part to monitor/upgrade; need template edits.

Environment and secrets
-----------------------
- Copy `nginx/env.example` to `nginx/.env` and adjust ports/sizes.
- Persistent volumes under `nginx/zpush/{config,state,log}`.

Backups and revert
------------------
- Always back up your templates first:
  - `./manage.sh --backup-templates /opt/zimbra/conf/nginx/templates`
- To auto-apply and later remove only our changes:
  - Apply: `./manage.sh --patch-templates-auto /opt/zimbra/conf/nginx/templates`
  - Revert: `./manage.sh --revert-templates-auto /opt/zimbra/conf/nginx/templates`
    - This deletes blocks marked `# BEGIN/END zpush-eas` and the `upstream zpush` block marked `# injected-by-manage.sh`.
- To fully restore a previous snapshot:
  - `./manage.sh --restore-templates /opt/zimbra/conf/nginx/templates /path/to/backup-YYYYMMDD-HHMMSS.tar.gz`
- For dry-run checks on a non-Zimbra machine (local tree):
  - `./manage.sh --verify-templates /home/jad/openai/zimbra74/nginx/opt/zimbra/config`
  - `./manage.sh --patch-templates-auto /home/jad/openai/zimbra74/nginx/opt/zimbra/config`

Commands reference
------------------
Setup
- `./manage.sh --init`: Creates `.env` and persistent dirs.
- `./manage.sh --fetch`: Clones/updates Z-Push under `build/`.
- `./manage.sh --fetch-backend`: Downloads and stages the Zimbra Backend (Release74 pinned by default).
- `./manage.sh --vendor-backend`: Copies staged backend into the Z-Push tree.

Build & Run
- `./manage.sh --build`: Builds the container image.
- `./manage.sh --up`: Starts the container (builds if needed) binding `127.0.0.1:${ZPUSH_HTTP_PORT}`.
- `./manage.sh --down`: Stops and removes the container.
- `./manage.sh --logs`: Tails container logs.
- `./manage.sh --health`: Checks `http://127.0.0.1:${ZPUSH_HTTP_PORT}/healthz`.
- `./manage.sh --set-port <port>`: Updates `.env` to change the loopback port.

Proxy Snippets
- `./manage.sh --print-nginx`: Shows upstream + location blocks for Zimbra proxy.

Templates: Inspect & Patch
- `./manage.sh --verify-templates [dir]`: Greps template tree for EAS/autodiscover/zpush; pass a custom path like `/home/jad/openai/zimbra74/nginx/opt/zimbra/config`.
- `./manage.sh --patch-templates [dir]`: Creates a tar.gz backup and prints manual patching guidance.
- `./manage.sh --patch-templates-auto [dir]`: Auto-injects upstream+locations with per-file backups and markers; idempotent.

Templates: Backup & Revert
- `./manage.sh --backup-templates [dir]`: Creates `<parent>/<basename>-backup.tgz` (fails if it already exists).
- `./manage.sh --restore-templates <dir> [backup.tar.gz]`: Restores from a tarball. Defaults to `<parent>/<basename>-backup.tgz` if omitted.
- `./manage.sh --revert-templates-auto [dir]`: Removes only the injected blocks using markers; leaves unrelated edits untouched.
- Zimbra proxy mode: `zmprov mcf zimbraReverseProxyMailMode redirect`
- Regenerate: `zmproxyctl restart`
