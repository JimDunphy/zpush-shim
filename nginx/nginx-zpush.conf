server {
    listen 8080 default_server;
    listen [::]:8080 default_server;

    server_name _;

    # Z-Push lives here
    root /var/www/zpush;
    index index.php;

    # health endpoint
    location = /healthz {
        access_log off;
        add_header Content-Type text/plain;
        return 200 "ok\n";
    }

    # Only expose Z-Push endpoints explicitly
    location = /Microsoft-Server-ActiveSync {
        include fastcgi_params;
        fastcgi_param SCRIPT_FILENAME /var/www/zpush/index.php;
        fastcgi_param SCRIPT_NAME /index.php;
        fastcgi_param PATH_INFO /Microsoft-Server-ActiveSync;
        fastcgi_pass unix:/run/php/php-fpm.sock;
        client_max_body_size ${NGINX_CLIENT_MAX_BODY_SIZE};
        # EAS devices keep long-lived connections. Increase read timeouts.
        proxy_read_timeout 3600s;
        fastcgi_read_timeout 3600s;
    }

    location ~* ^/autodiscover/Autodiscover\.xml$ {
        include fastcgi_params;
        fastcgi_param SCRIPT_FILENAME /var/www/zpush/index.php;
        fastcgi_param SCRIPT_NAME /index.php;
        fastcgi_param PATH_INFO /autodiscover/Autodiscover.xml;
        fastcgi_pass unix:/run/php/php-fpm.sock;
        client_max_body_size ${NGINX_CLIENT_MAX_BODY_SIZE};
        proxy_read_timeout 60s;
        fastcgi_read_timeout 60s;
    }

    # Deny everything else by default.
    location / {
        return 404;
    }
}

